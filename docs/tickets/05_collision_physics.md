# チケット: 衝突判定と物理演算

## 概要
ボールとパドル、壁との衝突判定を実装し、反射角度の計算などの物理演算を行う。

## 実装内容
- 壁（上下）との衝突判定と反射
- パドルとの衝突判定
- パドル衝突位置に応じた反射角度の計算
- 得点判定（左右の壁を超えた場合）

## ToDo（TDD実装順）

### 1. CollisionHandlerクラスのテストを作成
- [x] tests/test_collision.pyを作成
- [x] CollisionHandlerクラスの存在テストを記述
- [x] テストを実行して失敗することを確認

### 2. CollisionHandlerクラスの基本実装
- [x] src/game/physics/__init__.pyを作成
- [x] src/game/physics/collision.pyを作成
- [x] CollisionHandlerクラスを定義
- [x] テストを実行して成功することを確認

### 3. 壁との衝突判定テストを作成
- [x] check_wall_collision()メソッドのテストを追加
- [x] 上壁（y <= 0）での衝突テストを追加
- [x] 下壁（y >= 585）での衝突テストを追加
- [x] テストを実行して失敗することを確認

### 4. 壁との衝突判定を実装
- [x] check_wall_collision(ball)メソッドを実装
- [x] 上壁判定（y <= 0）を実装
- [x] 下壁判定（y + size >= SCREEN_HEIGHT）を実装
- [x] 衝突時にTrueを返す処理を追加
- [x] テストを実行して成功することを確認

### 5. 壁での反射処理テストを作成
- [x] handle_wall_bounce()メソッドのテストを追加
- [x] Y方向速度の反転テストを追加
- [x] X方向速度が維持されることのテストを追加
- [x] テストを実行して失敗することを確認

### 6. 壁での反射処理を実装
- [x] handle_wall_bounce(ball)メソッドを実装
- [x] ball.vy = -ball.vyの処理を追加
- [x] 壁にめり込まないよう位置補正を追加
- [x] テストを実行して成功することを確認

### 7. パドルとの衝突判定テストを作成
- [x] check_paddle_collision()メソッドのテストを追加
- [x] 矩形の重なり判定テストを追加
- [x] 衝突していない場合のテストを追加
- [x] テストを実行して失敗することを確認

### 8. パドルとの衝突判定を実装
- [x] check_paddle_collision(ball, paddle)メソッドを実装
- [x] pygame.Rect.colliderect()を使用
- [x] ball.get_rect()とpaddle.get_rect()の衝突を判定
- [x] テストを実行して成功することを確認

### 9. パドル反射角度計算のテストを作成
- [x] calculate_bounce_angle()メソッドのテストを追加
- [x] パドル中心での反射（水平）テストを追加
- [x] パドル端での反射（角度付き）テストを追加
- [x] テストを実行して失敗することを確認

### 10. パドル反射角度計算を実装
- [x] calculate_bounce_angle(ball, paddle)メソッドを実装
- [x] 衝突位置の相対位置を計算（-1.0〜1.0）
- [x] 相対位置に応じたY速度の計算を実装
- [x] X速度の反転処理を追加
- [x] テストを実行して成功することを確認

### 11. パドル反射処理のテストを作成
- [x] handle_paddle_bounce()メソッドのテストを追加
- [x] ボールの加速（5%）テストを追加
- [x] 反射角度が適用されることのテストを追加
- [x] テストを実行して失敗することを確認

### 12. パドル反射処理を実装
- [x] handle_paddle_bounce(ball, paddle)メソッドを実装
- [x] calculate_bounce_angle()を呼び出し
- [x] ball.accelerate()を呼び出し
- [x] 新しい速度ベクトルを設定
- [x] テストを実行して成功することを確認

### 13. 得点判定のテストを作成
- [x] check_scoring()メソッドのテストを追加
- [x] 左壁通過（x < 0）でCPU得点のテストを追加
- [x] 右壁通過（x > 800）でプレイヤー得点のテストを追加
- [x] テストを実行して失敗することを確認

### 14. 得点判定を実装
- [x] check_scoring(ball)メソッドを実装
- [x] 左壁通過時に'cpu'を返す
- [x] 右壁通過時に'player'を返す
- [x] 通過していない場合はNoneを返す
- [x] 全テストを実行して成功することを確認

## 完了条件
- [x] ボールが壁で正しく反射する
- [x] パドルとの衝突が正確に判定される
- [x] パドル衝突位置に応じて反射角度が変化する
- [x] pytest tests/test_collision.pyが全てパスする